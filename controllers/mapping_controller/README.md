# 手动建图控制器

基于TurtleBot3的激光雷达建图系统，支持手动控制探索和实时地图构建。

## 核心功能

### 交互式建图
- **手动控制**: WASD键控制机器人运动
- **实时建图**: 激光雷达数据实时转换为栅格地图
- **多格式输出**: PPM图像、CSV数据、ASCII可视化
- **传感器融合**: LiDAR + GPS + 罗盘数据融合

### 技术特性
- **高精度建图**: 0.05米分辨率的栅格地图
- **四方向探测**: 前后左右四个激光雷达传感器
- **实时反馈**: 控制台显示传感器状态和地图构建进度
- **数据兼容**: 输出格式兼容下游定位算法

## 算法实现

### 建图核心算法
```python
def collect_scan_data():
    """激光雷达数据收集与处理"""
    # 获取四方向距离数据
    distances = {
        'front': get_sensor_distance('front'),
        'left': get_sensor_distance('left'), 
        'right': get_sensor_distance('right'),
        'back': get_sensor_distance('back')
    }
    
    # 结合机器人位姿信息
    position = get_robot_position()
    orientation = get_robot_orientation()
    
    # 转换为全局坐标系地图点
    return convert_to_global_coordinates(distances, position, orientation)
```

### 栅格地图表示
- **网格分辨率**: 0.05米/像素
- **数据编码**: 0(未知)、1(自由空间)、2(障碍物)
- **坐标系**: 机器人起始位置为原点的全局坐标系
- **更新策略**: 累积式建图，多次观测提高可靠性

## 控制接口

| 按键 | 功能 | 速度参数 |
|------|------|----------|
| **W** | 前进 | 2.0 rad/s |
| **S** | 后退 | -2.0 rad/s |
| **A** | 左转 | 2.0 rad/s |
| **D** | 右转 | -2.0 rad/s |
| **空格** | 停止 | 0.0 rad/s |
| **Q** | 保存并退出 | - |

## 传感器配置

### 激光雷达阵列
- **传感器数量**: 4个定向激光雷达
- **检测范围**: 0.1-5.0米
- **采样频率**: 每控制周期更新
- **数据精度**: 毫米级距离测量

### 位姿传感器
- **GPS**: 提供全局位置信息（米）
- **罗盘**: 提供方向角度信息（弧度）
- **更新频率**: 实时同步更新

## 输出格式

### 1. CSV数据文件 (`simple_map_data.txt`)
包含机器人详细扫描数据，格式为：
```csv
# X坐标,Y坐标,单元格值
-1.25,-0.85,1
-1.20,-0.85,1
-1.15,-0.85,2
```

### 2. PPM图像文件 (`map_image.ppm`)
- **格式**: P3 PPM彩色图像
- **颜色编码**: 
  - 白色(255,255,255): 自由空间
  - 黑色(0,0,0): 障碍物
  - 蓝色(0,0,255): 机器人轨迹
- **用途**: 可视化和报告生成

### 3. ASCII可视化 (`simple_map_visualization.txt`)
```
. . . # # #
. . . . # #
. . . . . #
```
- **符号**: '.'(自由空间)、'#'(障碍物)、' '(未知区域)

## 图像格式转换

### PPM到PNG转换
```bash
# 使用ImageMagick（如需安装）
convert map_image.ppm map_image.png

# 在线转换工具
# 访问 convertio.co 上传PPM文件转换
```

### 使用GIMP转换
1. 打开GIMP
2. File → Open → 选择map_image.ppm
3. File → Export As → 选择PNG格式

## 性能优化

### 建图效率
- **数据结构**: 字典存储稀疏地图，节省内存
- **实时处理**: 边探索边建图，无离线处理需求
- **坐标变换**: 优化的三角函数计算，减少计算开销

### 探索策略建议
1. **系统性探索**: 按区域逐步覆盖
2. **重叠观测**: 适当重复扫描提高精度
3. **边界探测**: 重点探索未知区域边界
4. **验证扫描**: 对关键区域进行多角度验证

## 使用流程

### 1. 环境准备
```bash
# 在Webots中打开turtlebot3_burger_world.wbt
# 设置mapping_controller为机器人控制器
```

### 2. 启动建图
```bash
# 运行Webots仿真
# 控制台显示传感器初始化信息
```

### 3. 手动探索
```bash
# 使用WASD键控制机器人移动
# 观察控制台实时输出的传感器数据
# 覆盖感兴趣的区域
```

### 4. 保存数据
```bash
# 按Q键触发保存流程
# 系统自动生成三种格式的地图文件
```

## 故障诊断

### 常见问题
- **传感器无响应**: 检查Webots传感器配置
- **坐标偏移**: 验证GPS和罗盘校准
- **地图不连续**: 确保探索轨迹有足够重叠
- **文件保存失败**: 检查目录权限和磁盘空间

### 调试输出
控制台实时显示：
- 传感器距离读数
- 机器人位姿信息
- 地图尺寸统计
- 文件保存状态

## 技术规格

- **外部依赖**: 仅Python标准库
- **内存占用**: 动态稀疏地图存储
- **计算复杂度**: O(n)线性扫描处理
- **文件兼容性**: 标准CSV和PPM格式

本建图系统为后续定位算法提供高质量地图数据，是完整SLAM系统的基础模块。
